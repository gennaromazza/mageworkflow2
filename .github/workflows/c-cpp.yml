name: Cross-Compile for Windows
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ mingw-w64 nsis

    - name: Set up MXE (M cross environment)
      run: |
        sudo apt-get install -y software-properties-common
        sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 86B72ED9
        sudo add-apt-repository "deb [arch=amd64] https://pkg.mxe.cc/repos/apt focal main"
        sudo apt-get update
        sudo apt-get install -y mxe-x86-64-w64-mingw32.static-qt5 mxe-x86-64-w64-mingw32.static-opencv mxe-x86-64-w64-mingw32.static-boost

    - name: Debug MXE installation
      run: |
        echo "MXE installation directory contents:"
        ls -R /usr/lib/mxe
        echo "Searching for Qt5Config.cmake:"
        find /usr/lib/mxe -name Qt5Config.cmake
        echo "Searching for BoostConfig.cmake:"
        find /usr/lib/mxe -name BoostConfig.cmake

    - name: Set MXE environment variables
      run: |
        MXE_PREFIX=$(find /usr/lib/mxe -type d -name "x86_64-w64-mingw32.static" | head -n 1)
        echo "MXE_PREFIX=$MXE_PREFIX" >> $GITHUB_ENV
        echo "PATH=$PATH:/usr/lib/mxe/usr/bin" >> $GITHUB_ENV

    - name: Verify MXE setup
      run: |
        echo "MXE_PREFIX: $MXE_PREFIX"
        echo "PATH: $PATH"
        ls -l $MXE_PREFIX || echo "MXE_PREFIX directory not found"
        QT_CMAKE_DIR=$(find $MXE_PREFIX -type d -name "Qt5" | head -n 1)
        BOOST_CMAKE_DIR=$(find $MXE_PREFIX -type d -name "Boost" | head -n 1)
        echo "Qt5 CMake directory: $QT_CMAKE_DIR"
        echo "Boost CMake directory: $BOOST_CMAKE_DIR"

    - name: Verify and copy icon
      run: |
        if [ -f "eab290ac-4e82-479f-b62e-9fb1d759a300.ico" ]; then
          echo "Icon file found"
          mkdir -p build
          cp eab290ac-4e82-479f-b62e-9fb1d759a300.ico build/
        else
          echo "Icon file not found"
          exit 1
        fi

    - name: Configure CMake for Windows
      run: |
        QT_CMAKE_DIR=$(find $MXE_PREFIX -type d -name "Qt5" | head -n 1)
        BOOST_CMAKE_DIR=$(find $MXE_PREFIX -type d -name "Boost" | head -n 1)
        cmake -S . -B build \
        -DCMAKE_TOOLCHAIN_FILE=$MXE_PREFIX/share/cmake/mxe-conf.cmake \
        -DCMAKE_FIND_ROOT_PATH=$MXE_PREFIX \
        -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
        -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
        -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
        -DQt5_DIR=$QT_CMAKE_DIR \
        -DBOOST_ROOT=$MXE_PREFIX \
        -DBoost_DIR=$BOOST_CMAKE_DIR

    - name: Build
      run: cmake --build build --config Release

    - name: Package with CPack
      run: |
        cd build
        cpack -G NSIS
        cd ..

    - name: List build directory contents
      run: |
        echo "Build directory contents:"
        ls -la build

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: PhotoWorkflow-Windows-Installer
        path: build/PhotoWorkflow-*-Windows.exe
        if-no-files-found: error

    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: build/
        if-no-files-found: warn

    - name: Upload CMake Configuration
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cmake-config
        path: |
          build/CMakeCache.txt
          build/CMakeFiles/CMakeError.log
          build/CMakeFiles/CMakeOutput.log
        if-no-files-found: warn
